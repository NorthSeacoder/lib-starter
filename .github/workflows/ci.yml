name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ä¸»è¦æµ‹è¯•ä»»åŠ¡ - åªåœ¨ Ubuntu ä¸Šè¿è¡Œä»¥èŠ‚çœ Actions åˆ†é’Ÿæ•°
  test:
    name: Test & Build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # åˆå¹¶æ‰€æœ‰æ£€æŸ¥åˆ°ä¸€ä¸ªæ­¥éª¤ï¼Œå‡å°‘ Actions å¼€é”€
      - name: Run all checks
        run: |
          echo "ğŸ” Running lint check..."
          pnpm lint:check

          echo "ğŸ¨ Running format check..."
          pnpm format:check

          echo "ğŸ“ Running type check..."
          pnpm typecheck

          echo "ğŸ§ª Running tests with coverage..."
          pnpm test:coverage

          echo "ğŸ—ï¸ Running build..."
          pnpm build

      # åªåœ¨ Node.js 20 ä¸Šè¿è¡Œçš„é¢å¤–æ£€æŸ¥
      - name: Additional checks (Node.js 20 only)
        if: matrix.node-version == 20
        run: |
          echo "ğŸ“¦ Checking exports..."
          pnpm check-exports

      - name: Upload coverage to Codecov
        if: matrix.node-version == 20
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯• - ä»…åœ¨ä¸»åˆ†æ”¯è¿è¡Œä»¥èŠ‚çœåˆ†é’Ÿæ•°
  cross-platform:
    name: Cross-platform test
    if: github.ref == 'refs/heads/main'
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-latest, macos-latest]
        node-version: [20]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # è·¨å¹³å°åªè¿è¡Œæ ¸å¿ƒæµ‹è¯•
      - name: Run core tests
        run: |
          pnpm test
          pnpm build

  # å‘å¸ƒä»»åŠ¡
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Release
        run: pnpm release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
